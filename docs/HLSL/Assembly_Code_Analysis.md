# æ±‡ç¼–ä»£ç åˆ†æ

#HLSL #æ±‡ç¼–åˆ†æ #æ€§èƒ½åˆ†æ #è°ƒè¯•

> æŒæ¡æ±‡ç¼–ä»£ç åˆ†ææŠ€å·§ï¼šé˜…è¯»æŠ€å·§ã€æ€§èƒ½åˆ†æã€å¯„å­˜å™¨ä½¿ç”¨åˆ†æ

## ğŸ“‹ ç›®å½•

- [é˜…è¯»æŠ€å·§](#é˜…è¯»æŠ€å·§)
- [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
- [å¯„å­˜å™¨ä½¿ç”¨åˆ†æ](#å¯„å­˜å™¨ä½¿ç”¨åˆ†æ)
- [å®è·µä»»åŠ¡](#å®è·µä»»åŠ¡)

---

## é˜…è¯»æŠ€å·§

### è¯†åˆ«åŸºæœ¬æ¨¡å¼

#### æ¨¡å¼1ï¼šç®€å•è®¡ç®—
```assembly
; HLSL: float result = a + b;
mov r0, a
mov r1, b
add r2, r0, r1
mov result, r2
```

**è¯†åˆ«è¦ç‚¹**ï¼š
- `mov` ç”¨äºæ•°æ®ç§»åŠ¨
- `add`/`sub`/`mul` ç”¨äºç®—æœ¯è¿ç®—
- ç»“æœé€šå¸¸å­˜å‚¨åœ¨ä¸´æ—¶å¯„å­˜å™¨ä¸­

#### æ¨¡å¼2ï¼šå‘é‡å½’ä¸€åŒ–
```assembly
; HLSL: float3 n = normalize(v);
dp3 r0, v, v        ; dot(v, v)
rsq r1, r0          ; 1.0 / sqrt(r0)
mul n, v, r1.xxx    ; v * r1
```

**è¯†åˆ«è¦ç‚¹**ï¼š
- `dp3` è®¡ç®—ç‚¹ç§¯ï¼ˆé•¿åº¦å¹³æ–¹ï¼‰
- `rsq` è®¡ç®—å¹³æ–¹æ ¹å€’æ•°
- `mul` ä¸æ ‡é‡ç›¸ä¹˜è¿›è¡Œå½’ä¸€åŒ–

#### æ¨¡å¼3ï¼šçŸ©é˜µä¹˜æ³•
```assembly
; HLSL: float4 pos = mul(vertex, matrix);
dp4 r0.x, vertex, c0    ; ç¬¬ä¸€è¡Œ
dp4 r0.y, vertex, c1    ; ç¬¬äºŒè¡Œ
dp4 r0.z, vertex, c2    ; ç¬¬ä¸‰è¡Œ
dp4 r0.w, vertex, c3   ; ç¬¬å››è¡Œ
mov pos, r0
```

**è¯†åˆ«è¦ç‚¹**ï¼š
- çŸ©é˜µä¹˜æ³•ä½¿ç”¨å¤šä¸ª `dp4` æŒ‡ä»¤
- æ¯ä¸ª `dp4` å¯¹åº”çŸ©é˜µçš„ä¸€è¡Œ
- å¸¸é‡å¯„å­˜å™¨ `c0-c3` å­˜å‚¨çŸ©é˜µ

### è¿½è¸ªæ•°æ®æµ

#### ç¤ºä¾‹ï¼šå¤æ‚è®¡ç®—
```assembly
; è¿½è¸ª value = (a * b + c) * d çš„è®¡ç®—æµç¨‹

mov r0, a           ; r0 = a
mov r1, b           ; r1 = b
mul r2, r0, r1      ; r2 = a * b
mov r3, c           ; r3 = c
add r4, r2, r3      ; r4 = a * b + c
mov r5, d           ; r5 = d
mul r6, r4, r5      ; r6 = (a * b + c) * d
mov value, r6       ; value = r6
```

**è¿½è¸ªæ–¹æ³•**ï¼š
1. ä»è¾“å…¥å¼€å§‹ï¼ˆ`a`, `b`, `c`, `d`ï¼‰
2. è·Ÿéšå¯„å­˜å™¨ä½¿ç”¨é“¾ï¼ˆ`r0` â†’ `r2` â†’ `r4` â†’ `r6`ï¼‰
3. åˆ°è¾¾æœ€ç»ˆè¾“å‡ºï¼ˆ`value`ï¼‰

### ç†è§£å¯„å­˜å™¨ä½¿ç”¨

#### å¯„å­˜å™¨ç”Ÿå‘½å‘¨æœŸ
```assembly
mov r0, a           ; r0 è¢«ä½¿ç”¨
mov r1, b           ; r1 è¢«ä½¿ç”¨
add r2, r0, r1      ; r0, r1 è¢«è¯»å–ï¼Œr2 è¢«å†™å…¥
mov r0, c           ; r0 è¢«é‡ç”¨ï¼ˆa ä¸å†éœ€è¦ï¼‰
mul r3, r2, r0      ; r2, r0 è¢«è¯»å–ï¼Œr3 è¢«å†™å…¥
```

**åˆ†æè¦ç‚¹**ï¼š
- å¯„å­˜å™¨ä½•æ—¶è¢«åˆ†é…
- å¯„å­˜å™¨ä½•æ—¶è¢«é‡Šæ”¾ï¼ˆé‡ç”¨ï¼‰
- å¯„å­˜å™¨å‹åŠ›ï¼ˆåŒæ—¶ä½¿ç”¨çš„å¯„å­˜å™¨æ•°ï¼‰

---

## æ€§èƒ½åˆ†æ

### æŒ‡ä»¤è®¡æ•°

#### ç»Ÿè®¡æŒ‡ä»¤æ•°
```assembly
; ç¤ºä¾‹å‡½æ•°
mov r0, a           ; 1
mov r1, b           ; 2
add r2, r0, r1      ; 3
mul r3, r2, c       ; 4
mov result, r3      ; 5
; æ€»è®¡ï¼š5 æ¡æŒ‡ä»¤
```

**åˆ†æå·¥å…·**ï¼š
- æ‰‹åŠ¨è®¡æ•°
- ä½¿ç”¨å·¥å…·è‡ªåŠ¨ç»Ÿè®¡
- å¯¹æ¯”ä¸åŒå®ç°çš„æŒ‡ä»¤æ•°

#### æŒ‡ä»¤ç±»å‹ç»Ÿè®¡
```assembly
; ç»Ÿè®¡å„ç±»å‹æŒ‡ä»¤æ•°é‡
; ç®—æœ¯æŒ‡ä»¤ï¼šadd, sub, mul, mad (4æ¡)
; ç§»åŠ¨æŒ‡ä»¤ï¼šmov (2æ¡)
; æ•°å­¦æŒ‡ä»¤ï¼šrsq, rcp (2æ¡)
; çº¹ç†æŒ‡ä»¤ï¼štex2d (1æ¡)
; æ€»è®¡ï¼š9 æ¡æŒ‡ä»¤
```

### çº¹ç†é‡‡æ ·æ¬¡æ•°

#### è¯†åˆ«çº¹ç†é‡‡æ ·
```assembly
tex2d r0, t0, s0    ; é‡‡æ ·1
tex2d r1, t1, s0    ; é‡‡æ ·2
tex2d r2, t2, s0    ; é‡‡æ ·3
; æ€»è®¡ï¼š3 æ¬¡çº¹ç†é‡‡æ ·
```

**æ€§èƒ½å½±å“**ï¼š
- çº¹ç†é‡‡æ ·é€šå¸¸æ˜¯æœ€æ…¢çš„æ“ä½œ
- å‡å°‘é‡‡æ ·æ¬¡æ•°å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
- è€ƒè™‘ä½¿ç”¨çº¹ç†æ•°ç»„æˆ–å›¾é›†

### åˆ†æ”¯ä»£ä»·è¯„ä¼°

#### è¯†åˆ«åˆ†æ”¯æŒ‡ä»¤
```assembly
if_gt r0, r1        ; åˆ†æ”¯å¼€å§‹
    mov r2, 1.0     ; åˆ†æ”¯å†…ä»£ç 
else
    mov r2, 0.0     ; else åˆ†æ”¯ä»£ç 
endif               ; åˆ†æ”¯ç»“æŸ
```

**æ€§èƒ½å½±å“**ï¼š
- åŠ¨æ€åˆ†æ”¯å¯èƒ½å¯¼è‡´æ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œ
- ç»Ÿä¸€åˆ†æ”¯ï¼ˆuniformï¼‰æ€§èƒ½å½±å“è¾ƒå°
- éç»Ÿä¸€åˆ†æ”¯ï¼ˆdivergentï¼‰æ€§èƒ½å½±å“å¤§

#### åˆ†æ”¯ä»£ä»·åˆ†æ
```assembly
; æƒ…å†µ1ï¼šç»Ÿä¸€åˆ†æ”¯ï¼ˆæ€§èƒ½å¥½ï¼‰
mov r0, c0          ; å¸¸é‡ï¼Œæ‰€æœ‰åƒç´ ç›¸åŒ
if_gt r0, 0.5
    ; åˆ†æ”¯ä»£ç 
endif

; æƒ…å†µ2ï¼šéç»Ÿä¸€åˆ†æ”¯ï¼ˆæ€§èƒ½å·®ï¼‰
mov r0, v0          ; æ¯ä¸ªåƒç´ ä¸åŒ
if_gt r0, 0.5
    ; åˆ†æ”¯ä»£ç 
endif
```

### å¯„å­˜å™¨å‹åŠ›åˆ†æ

#### è®¡ç®—å¯„å­˜å™¨ä½¿ç”¨
```assembly
; åŒæ—¶ä½¿ç”¨çš„å¯„å­˜å™¨
mov r0, a           ; ä½¿ç”¨ r0
mov r1, b           ; ä½¿ç”¨ r0, r1
mov r2, c           ; ä½¿ç”¨ r0, r1, r2
add r3, r0, r1      ; ä½¿ç”¨ r0, r1, r2, r3
mov r0, d           ; r0 è¢«é‡ç”¨ï¼Œä½¿ç”¨ r1, r2, r3
; æœ€å¤§åŒæ—¶ä½¿ç”¨ï¼š4 ä¸ªå¯„å­˜å™¨
```

**åˆ†æè¦ç‚¹**ï¼š
- æœ€å¤§åŒæ—¶ä½¿ç”¨çš„å¯„å­˜å™¨æ•°
- å¯„å­˜å™¨æº¢å‡ºï¼ˆspillingï¼‰æƒ…å†µ
- å¯„å­˜å™¨é‡ç”¨æ•ˆç‡

---

## å¯„å­˜å™¨ä½¿ç”¨åˆ†æ

### å¯„å­˜å™¨åˆ†é…ç­–ç•¥

#### ç¤ºä¾‹ï¼šå¯„å­˜å™¨åˆ†é…
```assembly
; æºä»£ç ï¼šresult = a + b + c + d

; ç­–ç•¥1ï¼šçº¿æ€§åˆ†é…ï¼ˆæµªè´¹å¯„å­˜å™¨ï¼‰
mov r0, a
mov r1, b
add r2, r0, r1      ; r2 = a + b
mov r3, c
add r4, r2, r3      ; r4 = a + b + c
mov r5, d
add r6, r4, r5      ; r6 = a + b + c + d
; ä½¿ç”¨å¯„å­˜å™¨ï¼šr0-r6 (7ä¸ª)

; ç­–ç•¥2ï¼šé‡ç”¨å¯„å­˜å™¨ï¼ˆé«˜æ•ˆï¼‰
mov r0, a
mov r1, b
add r0, r0, r1      ; r0 = a + b (é‡ç”¨)
mov r1, c           ; r1 è¢«é‡ç”¨
add r0, r0, r1      ; r0 = a + b + c
mov r1, d           ; r1 è¢«é‡ç”¨
add r0, r0, r1      ; r0 = a + b + c + d
; ä½¿ç”¨å¯„å­˜å™¨ï¼šr0, r1 (2ä¸ª)
```

### å¯„å­˜å™¨æº¢å‡ºï¼ˆSpillingï¼‰

#### è¯†åˆ«æº¢å‡º
```assembly
; å½“å¯„å­˜å™¨ä¸è¶³æ—¶ï¼Œæ•°æ®è¢«å†™å…¥å†…å­˜
mov r0, a
; ... ä½¿ç”¨ r0-r31ï¼ˆæ‰€æœ‰å¯„å­˜å™¨éƒ½è¢«ä½¿ç”¨ï¼‰
mov r32, b          ; å¯„å­˜å™¨æº¢å‡ºï¼Œå†™å…¥å†…å­˜
; åç»­éœ€è¦ä»å†…å­˜è¯»å–
mov r0, r32         ; ä»å†…å­˜è¯»å–
```

**æ€§èƒ½å½±å“**ï¼š
- å†…å­˜è®¿é—®æ¯”å¯„å­˜å™¨è®¿é—®æ…¢å¾—å¤š
- åº”è¯¥å°½é‡é¿å…å¯„å­˜å™¨æº¢å‡º
- ä¼˜åŒ–å¯„å­˜å™¨ä½¿ç”¨å¯ä»¥å‡å°‘æº¢å‡º

### å¯„å­˜å™¨é‡ç”¨åˆ†æ

#### é‡ç”¨æ•ˆç‡
```assembly
; å¥½çš„é‡ç”¨ï¼šå¯„å­˜å™¨åŠæ—¶é‡Šæ”¾
mov r0, a           ; r0 åˆ†é…
add r1, r0, b       ; ä½¿ç”¨ r0
mov r0, c           ; r0 ç«‹å³é‡ç”¨ï¼ˆa ä¸å†éœ€è¦ï¼‰

; å·®çš„é‡ç”¨ï¼šå¯„å­˜å™¨é•¿æ—¶é—´å ç”¨
mov r0, a           ; r0 åˆ†é…
mov r1, b
mov r2, c
; ... å¾ˆå¤šæŒ‡ä»¤å
mov r3, r0          ; r0 æ‰è¢«é‡Šæ”¾
```

---

## å®è·µä»»åŠ¡

### ä»»åŠ¡1ï¼šåˆ†æå¤æ‚ HLSL å‡½æ•°çš„æ±‡ç¼–è¾“å‡º

#### æ­¥éª¤1ï¼šç¼–å†™æµ‹è¯•å‡½æ•°
```hlsl
float4 PS_Main(
    float2 uv : TEXCOORD0,
    Texture2D tex : register(t0),
    SamplerState samp : register(s0)
) : SV_Target {
    float4 color = tex.Sample(samp, uv);
    float gray = dot(color.rgb, float3(0.299, 0.587, 0.114));
    float3 result = lerp(color.rgb, float3(gray, gray, gray), 0.5);
    return float4(result, color.a);
}
```

#### æ­¥éª¤2ï¼šç”Ÿæˆæ±‡ç¼–
```bash
fxc /T ps_5_0 /Fc output.asm shader.hlsl
```

#### æ­¥éª¤3ï¼šåˆ†ææ±‡ç¼–
- è¯†åˆ«çº¹ç†é‡‡æ ·æŒ‡ä»¤
- è¿½è¸ªé¢œè‰²è®¡ç®—æµç¨‹
- ç»Ÿè®¡æŒ‡ä»¤æ•°é‡
- åˆ†æå¯„å­˜å™¨ä½¿ç”¨

### ä»»åŠ¡2ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

#### å¯¹æ¯”ä¸åŒå®ç°
```hlsl
// å®ç°1ï¼šä½¿ç”¨åˆ†æ”¯
float GetValue(float x) {
    if (x > 0.5) {
        return 1.0;
    } else {
        return 0.0;
    }
}

// å®ç°2ï¼šæ— åˆ†æ”¯
float GetValue(float x) {
    return step(0.5, x);
}
```

#### åˆ†ææ±‡ç¼–å·®å¼‚
- å®ç°1ï¼šåŒ…å« `if` æŒ‡ä»¤
- å®ç°2ï¼šä½¿ç”¨ `step` å‡½æ•°ï¼ˆå¯èƒ½æ›´é«˜æ•ˆï¼‰

### ä»»åŠ¡3ï¼šä¼˜åŒ–å¯„å­˜å™¨ä½¿ç”¨

#### åˆ†æå½“å‰å®ç°
```hlsl
float4 Calculate(float a, float b, float c, float d) {
    float temp1 = a + b;
    float temp2 = c + d;
    float temp3 = temp1 * temp2;
    return float4(temp3, temp3, temp3, 1.0);
}
```

#### ä¼˜åŒ–å»ºè®®
- å‡å°‘ä¸­é—´å˜é‡
- é‡ç”¨å¯„å­˜å™¨
- åˆå¹¶è®¡ç®—

---

## åˆ†æå·¥å…·

### æ‰‹åŠ¨åˆ†æ
- é˜…è¯»æ±‡ç¼–ä»£ç 
- è¿½è¸ªæ•°æ®æµ
- ç»Ÿè®¡æŒ‡ä»¤æ•°

### è‡ªåŠ¨åŒ–å·¥å…·
- **RenderDoc**ï¼šè¿è¡Œæ—¶åˆ†æ
- **GPU ShaderAnalyzer**ï¼šAMD å·¥å…·
- **Nsight Graphics**ï¼šNVIDIA å·¥å…·
- **PIX**ï¼šWindows å›¾å½¢è°ƒè¯•å™¨

### ç¼–è¯‘å™¨è¾“å‡º
```bash
# ç”Ÿæˆè¯¦ç»†çš„æ±‡ç¼–è¾“å‡º
fxc /T ps_5_0 /Fc output.asm /Od shader.hlsl  # æ— ä¼˜åŒ–
fxc /T ps_5_0 /Fc output_opt.asm /O3 shader.hlsl  # ä¼˜åŒ–å

# å¯¹æ¯”åˆ†æ
diff output.asm output_opt.asm
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [[Assembly_Basics]] - æŒ‡ä»¤ç±»å‹
- [[Compilation_Pipeline]] - ç¼–è¯‘å™¨ä¼˜åŒ–
- [[Performance_Optimization]] - ä¼˜åŒ–æŠ€å·§
- [[Tools_Guide]] - åˆ†æå·¥å…·

---

*æœ€åæ›´æ–°ï¼š2024å¹´*

