# æ±‡ç¼–åŸºç¡€

#HLSL #æ±‡ç¼– #Assembly #æŒ‡ä»¤é›†

> å­¦ä¹ æ±‡ç¼–åŸºç¡€ï¼šå¯„å­˜å™¨ç±»å‹ã€æŒ‡ä»¤æ ¼å¼ã€å¸¸ç”¨æŒ‡ä»¤

## ğŸ“‹ ç›®å½•

- [å¯„å­˜å™¨ç±»å‹](#å¯„å­˜å™¨ç±»å‹)
- [æŒ‡ä»¤æ ¼å¼](#æŒ‡ä»¤æ ¼å¼)
- [å¸¸ç”¨æŒ‡ä»¤](#å¸¸ç”¨æŒ‡ä»¤)
- [å®è·µä»»åŠ¡](#å®è·µä»»åŠ¡)

---

## å¯„å­˜å™¨ç±»å‹

### ä¸´æ—¶å¯„å­˜å™¨ï¼ˆ`r#`ï¼‰

ç”¨äºå­˜å‚¨ä¸­é—´è®¡ç®—ç»“æœï¼š

```assembly
mov r0, c0          ; å°†å¸¸é‡ c0 ç§»åŠ¨åˆ°ä¸´æ—¶å¯„å­˜å™¨ r0
add r1, r0, r2       ; r1 = r0 + r2
mul r2, r1, r3       ; r2 = r1 * r3
```

**ç‰¹ç‚¹**ï¼š
- æ•°é‡æœ‰é™ï¼ˆé€šå¸¸ 32-4096 ä¸ªï¼Œå–å†³äº Shader Modelï¼‰
- ç”Ÿå‘½å‘¨æœŸçŸ­
- å¯ä»¥è‡ªç”±è¯»å†™

### è¾“å…¥å¯„å­˜å™¨ï¼ˆ`v#`ï¼‰

é¡¶ç‚¹ç€è‰²å™¨çš„è¾“å…¥æ•°æ®ï¼š

```assembly
; é¡¶ç‚¹ç€è‰²å™¨è¾“å…¥
mov r0, v0          ; v0 = POSITION
mov r1, v1          ; v1 = NORMAL
mov r2, v2          ; v2 = TEXCOORD0
```

**ç‰¹ç‚¹**ï¼š
- åªè¯»
- å¯¹åº”é¡¶ç‚¹ç¼“å†²åŒºä¸­çš„æ•°æ®
- æ•°é‡æœ‰é™ï¼ˆé€šå¸¸ 16 ä¸ªï¼‰

### è¾“å‡ºå¯„å­˜å™¨ï¼ˆ`o#`ï¼‰

é¡¶ç‚¹ç€è‰²å™¨çš„è¾“å‡ºæ•°æ®ï¼š

```assembly
; é¡¶ç‚¹ç€è‰²å™¨è¾“å‡º
mov o0, r0          ; o0 = SV_POSITION
mov o1, r1          ; o1 = TEXCOORD0
mov o2, r2          ; o2 = COLOR0
```

**ç‰¹ç‚¹**ï¼š
- åªå†™ï¼ˆåœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­ï¼‰
- ä¼šè¢«æ’å€¼åä¼ é€’ç»™åƒç´ ç€è‰²å™¨
- æ•°é‡æœ‰é™ï¼ˆé€šå¸¸ 10-32 ä¸ªï¼‰

### å¸¸é‡å¯„å­˜å™¨ï¼ˆ`c#`ï¼‰

å­˜å‚¨å¸¸é‡æ•°æ®ï¼š

```assembly
mov r0, c0          ; ä»å¸¸é‡ç¼“å†²åŒºè¯»å–
mul r1, r0, c1      ; ä½¿ç”¨å¸¸é‡ c1
```

**ç‰¹ç‚¹**ï¼š
- åªè¯»
- å¯¹åº”å¸¸é‡ç¼“å†²åŒºï¼ˆCBufferï¼‰
- æ•°é‡è¾ƒå¤§ï¼ˆé€šå¸¸ 256-4096 ä¸ªï¼‰

### çº¹ç†å¯„å­˜å™¨ï¼ˆ`t#`ï¼‰

çº¹ç†èµ„æºï¼š

```assembly
texld r0, t0, s0    ; ä»çº¹ç† t0 é‡‡æ ·ï¼Œä½¿ç”¨é‡‡æ ·å™¨ s0
```

**ç‰¹ç‚¹**ï¼š
- åªè¯»
- å¯¹åº”çº¹ç†èµ„æº
- æ•°é‡æœ‰é™ï¼ˆé€šå¸¸ 128 ä¸ªï¼‰

### é‡‡æ ·å™¨å¯„å­˜å™¨ï¼ˆ`s#`ï¼‰

é‡‡æ ·å™¨çŠ¶æ€ï¼š

```assembly
texld r0, t0, s0    ; ä½¿ç”¨é‡‡æ ·å™¨ s0
```

**ç‰¹ç‚¹**ï¼š
- åªè¯»
- å®šä¹‰çº¹ç†é‡‡æ ·æ–¹å¼
- æ•°é‡æœ‰é™ï¼ˆé€šå¸¸ 16 ä¸ªï¼‰

---

## æŒ‡ä»¤æ ¼å¼

### åŸºæœ¬æ ¼å¼

```
opcode dest, src0 [, src1, ...]
```

**ç¤ºä¾‹**ï¼š
```assembly
add r0, r1, r2      ; r0 = r1 + r2
mul r3, r0, c0      ; r3 = r0 * c0
```

### Swizzle å’Œ Mask

#### Swizzleï¼ˆåˆ†é‡é€‰æ‹©ï¼‰
```assembly
mov r0.xy, r1.zw    ; r0.xy = r1.zw
mov r0.x, r1.y      ; r0.x = r1.y
mov r0.xyz, r1.xxx  ; r0.xyz = (r1.x, r1.x, r1.x)
```

#### Maskï¼ˆå†™å…¥æ©ç ï¼‰
```assembly
mov r0.xy, r1.xy    ; åªå†™å…¥ r0 çš„ x å’Œ y åˆ†é‡
mov r0.x, r1.y      ; åªå†™å…¥ r0 çš„ x åˆ†é‡
```

**Swizzle æ¨¡å¼**ï¼š
- `.xyzw` - ä½ç½®å‘½å
- `.rgba` - é¢œè‰²å‘½å
- `.stpq` - çº¹ç†åæ ‡å‘½å

### ä¿®é¥°ç¬¦

#### `saturate` - é¥±å’Œï¼ˆé™åˆ¶åˆ° [0, 1]ï¼‰
```assembly
add_sat r0, r1, r2  ; r0 = saturate(r1 + r2)
```

#### `negate` - å–å
```assembly
add r0, r1, -r2     ; r0 = r1 + (-r2)
```

#### ç»„åˆä¿®é¥°ç¬¦
```assembly
mad_sat r0, r1, r2, r3  ; r0 = saturate(r1 * r2 + r3)
```

---

## å¸¸ç”¨æŒ‡ä»¤

### ç®—æœ¯æŒ‡ä»¤

#### `add` - åŠ æ³•
```assembly
add r0, r1, r2      ; r0 = r1 + r2
add r0.xy, r1, r2   ; å‘é‡åŠ æ³•
```

#### `sub` - å‡æ³•
```assembly
sub r0, r1, r2      ; r0 = r1 - r2
```

#### `mul` - ä¹˜æ³•
```assembly
mul r0, r1, r2      ; r0 = r1 * r2
mul r0.xyz, r1, r2  ; åˆ†é‡ä¹˜æ³•
```

#### `mad` - ä¹˜åŠ ï¼ˆèåˆæŒ‡ä»¤ï¼‰
```assembly
mad r0, r1, r2, r3  ; r0 = r1 * r2 + r3
; ç­‰ä»·äºï¼šmul r0, r1, r2; add r0, r0, r3
; ä½† mad åªéœ€è¦ä¸€æ¡æŒ‡ä»¤
```

#### `div` - é™¤æ³•
```assembly
div r0, r1, r2      ; r0 = r1 / r2
```

> âš ï¸ **æ³¨æ„**ï¼šé™¤æ³•æŒ‡ä»¤é€šå¸¸è¾ƒæ…¢ï¼Œå°½é‡é¿å…ä½¿ç”¨ã€‚è€ƒè™‘ä½¿ç”¨ `rcp`ï¼ˆå€’æ•°ï¼‰å’Œä¹˜æ³•ã€‚

### å‘é‡æŒ‡ä»¤

#### `dp3` - 3D ç‚¹ç§¯
```assembly
dp3 r0, r1, r2      ; r0 = dot(r1.xyz, r2.xyz)
```

#### `dp4` - 4D ç‚¹ç§¯
```assembly
dp4 r0, r1, r2      ; r0 = dot(r1, r2)
```

#### `mov` - ç§»åŠ¨
```assembly
mov r0, r1          ; r0 = r1
mov r0.xy, r1.zw    ; å¤åˆ¶åˆ†é‡
```

#### `min` - æœ€å°å€¼
```assembly
min r0, r1, r2      ; r0 = min(r1, r2)
```

#### `max` - æœ€å¤§å€¼
```assembly
max r0, r1, r2      ; r0 = max(r1, r2)
```

### æ•°å­¦æŒ‡ä»¤

#### `rsq` - å¹³æ–¹æ ¹å€’æ•°
```assembly
rsq r0, r1          ; r0 = 1.0 / sqrt(r1)
```

**å¯¹åº” HLSL**ï¼š
```hlsl
float result = rsqrt(x);  // ç¼–è¯‘ä¸º rsq æŒ‡ä»¤
```

#### `rcp` - å€’æ•°
```assembly
rcp r0, r1          ; r0 = 1.0 / r1
```

**å¯¹åº” HLSL**ï¼š
```hlsl
float result = rcp(x);  // ç¼–è¯‘ä¸º rcp æŒ‡ä»¤
```

#### `sqrt` - å¹³æ–¹æ ¹
```assembly
sqrt r0, r1         ; r0 = sqrt(r1)
```

#### `exp` - æŒ‡æ•°
```assembly
exp r0, r1          ; r0 = exp(r1)
```

#### `log` - å¯¹æ•°
```assembly
log r0, r1          ; r0 = log(r1)
```

#### `sincos` - æ­£å¼¦å’Œä½™å¼¦
```assembly
sincos r0.xy, r1    ; r0.x = sin(r1), r0.y = cos(r1)
```

### çº¹ç†æŒ‡ä»¤

#### `texld` - çº¹ç†é‡‡æ ·ï¼ˆSM 2.0/3.0ï¼‰
```assembly
texld r0, t0, s0    ; r0 = texture2D(t0, s0)
```

#### `tex2d` - 2D çº¹ç†é‡‡æ ·ï¼ˆSM 4.0+ï¼‰
```assembly
tex2d r0, t0, s0    ; r0 = texture2D(t0, s0)
```

#### `texldp` - æŠ•å½±çº¹ç†é‡‡æ ·
```assembly
texldp r0, t0, s0   ; æŠ•å½±é‡‡æ ·
```

### åˆ†æ”¯æŒ‡ä»¤

#### `if` - æ¡ä»¶åˆ†æ”¯
```assembly
if_lt r0, r1        ; if (r0 < r1)
    ; åˆ†æ”¯ä»£ç 
endif
```

#### `else` - å¦åˆ™åˆ†æ”¯
```assembly
if_lt r0, r1
    ; åˆ†æ”¯1
else
    ; åˆ†æ”¯2
endif
```

#### `call` - å‡½æ•°è°ƒç”¨
```assembly
call function_name  ; è°ƒç”¨å‡½æ•°
```

#### `ret` - è¿”å›
```assembly
ret                 ; è¿”å›
```

---

## HLSL åˆ°æ±‡ç¼–æ˜ å°„ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç®€å•è®¡ç®—
```hlsl
// HLSL
float result = a * b + c;
```

```assembly
; æ±‡ç¼–ï¼ˆå¯èƒ½è¢«ä¼˜åŒ–ä¸º madï¼‰
mul r0, a, b
add r1, r0, c
; æˆ–ä¼˜åŒ–ä¸ºï¼š
mad r1, a, b, c
```

### ç¤ºä¾‹2ï¼šå‘é‡å½’ä¸€åŒ–
```hlsl
// HLSL
float3 normalized = normalize(vector);
```

```assembly
; æ±‡ç¼–
dp3 r0, vector, vector    ; dot(vector, vector)
rsq r1, r0                ; 1.0 / sqrt(r0)
mul normalized, vector, r1.xxx  ; vector * r1
```

### ç¤ºä¾‹3ï¼šæ¡ä»¶åˆ†æ”¯
```hlsl
// HLSL
if (x > 0.5) {
    result = 1.0;
} else {
    result = 0.0;
}
```

```assembly
; æ±‡ç¼–
mov r0, x
mov r1, 0.5
if_gt r0, r1
    mov result, 1.0
else
    mov result, 0.0
endif
```

---

## å®è·µä»»åŠ¡

### ä»»åŠ¡1ï¼šé˜…è¯»ç®€å• HLSL ä»£ç çš„æ±‡ç¼–è¾“å‡º

ç¼–å†™ç®€å•çš„ HLSL ä»£ç ï¼š

```hlsl
float4 PS_Main(float2 uv : TEXCOORD0) : SV_Target {
    float4 color = float4(1.0, 0.0, 0.0, 1.0);
    float value = uv.x * uv.y;
    return color * value;
}
```

ä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆæ±‡ç¼–ï¼š

```bash
fxc /T ps_5_0 /Fc output.asm shader.hlsl
```

åˆ†æç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼Œç†è§£æ¯æ¡æŒ‡ä»¤çš„ä½œç”¨ã€‚

### ä»»åŠ¡2ï¼šæ‰‹åŠ¨ç¼–å†™ç®€å•çš„æ±‡ç¼–ä»£ç 

å°è¯•æ‰‹åŠ¨ç¼–å†™ç®€å•çš„æ±‡ç¼–ä»£ç ï¼ˆå¦‚æœå·¥å…·æ”¯æŒï¼‰ï¼Œæˆ–åˆ†æç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ã€‚

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [[Compilation_Pipeline]] - å¦‚ä½•ç”Ÿæˆæ±‡ç¼–
- [[Assembly_Code_Analysis]] - å¦‚ä½•åˆ†ææ±‡ç¼–
- [[Performance_Optimization]] - æŒ‡ä»¤ä¼˜åŒ–
- [[Shader_Model_Versions]] - ä¸åŒç‰ˆæœ¬çš„æŒ‡ä»¤å·®å¼‚

---

*æœ€åæ›´æ–°ï¼š2024å¹´*

